sequenceDiagram
    actor Technician
    participant RequestsPage as RequestsPage (app/(dashboard)/requests/page.tsx)
    participant OrderHook as useAuthedSWR('/orders/confirmed')
    participant OrderItemsHook as useAuthedSWR(`/orders/${orderId}/items`)
    participant Totals as loadExistingTotals(orderId)
    participant ApiFetch as apiFetch(...)
    participant Backend as Inventory API

    Technician->>RequestsPage: เปิดเมนู Requests และเลือก "สร้างคำขอ"
    RequestsPage->>OrderHook: useAuthedSWR('/orders/confirmed', token)
    OrderHook->>ApiFetch: apiFetch('/orders/confirmed', { token })
    ApiFetch->>Backend: GET /orders/confirmed
    Backend-->>RequestsPage: รายการ Order ที่ยืนยันแล้ว

    Technician->>RequestsPage: เลือก Order เพื่อสร้างคำขอ
    RequestsPage->>RequestsPage: handleOrderSelection(orderId)
    RequestsPage->>OrderItemsHook: useAuthedSWR(`/orders/${orderId}/items`, token)
    OrderItemsHook->>ApiFetch: apiFetch(`/orders/${orderId}/items`, { token })
    ApiFetch->>Backend: GET /orders/{orderId}/items
    Backend-->>RequestsPage: รายการสินค้าใน Order
    RequestsPage->>Totals: loadExistingTotals(orderId)
    Totals->>ApiFetch: apiFetch(`/requests?orderId=${orderId}`, { token })
    ApiFetch->>Backend: GET /requests?orderId=...
    Backend-->>Totals: คำขอที่เกี่ยวข้อง
    loop รวมจำนวนที่เคยขอไปแล้ว
        Totals->>ApiFetch: apiFetch(`/requests/${requestId}/items`, { token })
        ApiFetch->>Backend: GET /requests/{requestId}/items
        Backend-->>Totals: รายการสินค้า
    end
    Totals-->>RequestsPage: Map ของจำนวนที่ขอไว้ก่อนหน้า

    Technician->>RequestsPage: กรอกสินค้าและจำนวนใน draftItems
    RequestsPage->>RequestsPage: handleCreateRequest(event)
    RequestsPage->>RequestsPage: ตรวจสอบปริมาณเทียบ Order และ existing totals
    alt ตรวจสอบผ่าน
        RequestsPage->>ApiFetch: apiFetch('/requests', { method: 'POST', body, token })
        ApiFetch->>Backend: POST /requests payload
        Backend-->>ApiFetch: RequestId ใหม่
        ApiFetch-->>RequestsPage: บันทึกสำเร็จ
        RequestsPage->>RequestsPage: form.reset() + setSuccessMessage()
        RequestsPage->>RequestsPage: mutatePending() / mutateApproved()
        loop revalidate SWR keys
            RequestsPage->>ApiFetch: apiFetch('<endpoint>', { token })
            ApiFetch->>Backend: GET endpoint
            Backend-->>RequestsPage: ข้อมูลล่าสุด
        end
    else มีข้อผิดพลาด
        RequestsPage-->>Technician: แสดง error message
    end
