sequenceDiagram
    actor Warehouse
    participant RequestsPage as RequestsPage (app/(dashboard)/requests/page.tsx)
    participant ApprovedHook as useAuthedSWR('/stock/approved-requests')
    participant ItemsHook as useAuthedSWR(`/requests/${id}/items`)
    participant ApiFetch as apiFetch(...)
    participant Backend as Inventory API

    Warehouse->>RequestsPage: เปิดแท็บ "คำขอรอจัดสินค้า"
    RequestsPage->>ApprovedHook: useAuthedSWR('/stock/approved-requests', token)
    ApprovedHook->>ApiFetch: apiFetch('/stock/approved-requests', { token })
    ApiFetch->>Backend: GET /stock/approved-requests
    Backend-->>RequestsPage: คำขอที่อนุมัติแล้ว

    Warehouse->>RequestsPage: เลือกคำขอเพื่อเบิกสินค้า
    RequestsPage->>ItemsHook: useAuthedSWR(`/requests/${requestId}/items`, token)
    ItemsHook->>ApiFetch: apiFetch(`/requests/${requestId}/items`, { token })
    ApiFetch->>Backend: GET /requests/{requestId}/items
    Backend-->>RequestsPage: รายการสินค้าและจำนวนคงเหลือ

    Warehouse->>RequestsPage: ใส่จำนวนที่จะเบิกสำหรับแต่ละรายการ
    Warehouse->>RequestsPage: กดปุ่ม "บันทึกการเบิก"
    RequestsPage->>RequestsPage: handleFulfillAll()
    loop สำหรับแต่ละรายการที่สามารถเบิกได้
        RequestsPage->>ApiFetch: apiFetch('/stock/fulfill', { method: 'POST', body: { requestItemId, fulfillQty }, token })
        ApiFetch->>Backend: POST /stock/fulfill
        Backend-->>ApiFetch: ผลลัพธ์ของรายการนั้น
        ApiFetch-->>RequestsPage: อัปเดตสำเร็จ
    end
    RequestsPage->>RequestsPage: setSuccessMessage() + setFulfillQuantities({})
    RequestsPage->>ApprovedHook: mutate()
    ApprovedHook->>ApiFetch: apiFetch('/stock/approved-requests', { token })
    ApiFetch->>Backend: GET /stock/approved-requests (refresh)
    Backend-->>RequestsPage: สถานะล่าสุด
    RequestsPage->>RequestsPage: mutateReady() + mutateProducts()
    RequestsPage-->>Warehouse: แจ้งผลการเบิกและสถานะคำขอ
